## SQL Format

If you are not confident with the SQL language, we suggest to read [this tutorial](http://www.w3schools.com/sql/default.asp) before starting.

Also remember to:

- always use [UPDATE](http://www.w3schools.com/sql/sql_update.asp) in order to change the value of fields of **existing rows**

- use [INSERT](http://www.w3schools.com/sql/sql_insert.asp) in order to insert **new rows only**, but be sure to avoid import errors using [DELETE](http://www.w3schools.com/sql/sql_delete.asp) before INSERT

- surround any table or field name with `backticks`, and string values with `single quotes`, example:

``UPDATE `table_name` SET `field_I_want_to_change` = 'new string value' WHERE `entry` = 10``

## How to create an sql update file

There are essentially 3 ways to create an update file:

1) Creating a versioned pending sql file ( Recommended )

2) Creating a NOT versioned pending file ( Not Recommended, but possible )

3) Adding updates directly under updates/db_* folders ( Only for devs )

_If you want to understand sql versioning more in depth, you've to read this article first [[Sql Versioning|sql-Versioning]]_

### 1. Creating a versioned pending sql file ( Recommended )

This kind of procedure is pretty simple and allow any kind of dev, but also testers, to avoid multiple import of the same queries.

We can proceed by steps:

1. go into **data/sql/updates** and choose the pending folder of the database that you have to create the sql file.

2. run the create_sql.sh script with your bash console ( git bash on windows, the terminal on unix / osx )

3. now you'll have a file called **rev_[a_long_number].sql** , you can open it and add your queries

4. commit and push. If you are not a dev now you've to create the PR.

substantially your job is terminated, read [#import-system-for-pending-sql-files](#import-system-for-pending-sql-files) to know what will happen to your files

#### [ALTERNATIVE] Create versioned sql manually
   N.B. Eventually, you can also manually create the sql file without using the script ( But if you have problem with please report it ). The steps are the following:

   1) run this command inside a bash shell: `date +%s%N  `

   2) with the result of this command you've to create a file called: rev_**commandresult**.sql  where **commandresult** is the number generated by date +%s%N.

   3) inside the file put at the first line this query: `INSERT INTO version_db_**CHOSEN_DB**(sql_rev) VALUES ('**commandresult**'); ` , modify **CHOSEN_DB** with the right database name (auth, world, characters), overwrite **commandresult** with your number of course and finally add your queries inside the file.



### 2. Creating a NOT versioned pending file ( Not Recommended, but possible )

This is not recommended for devs nor for external contributors, but it is supported by our import system for some special cases. Most of the time we will suggest you to use the 1. solution.

The process however is very simple: just create an sql under the needed pending folder, without using the script. You can call it as you want, of course we suggest you to use an unique name to avoid collisions with other pending files ( for example the date with time too, for example: **20xx_08_15_h_14_30.sql **

This file will be normally processed from our import system, but the protection system for devs won't be included.


#### import system for pending sql files

Under /bin/db_pending folder you can find a script that , when launched, it processes all files under updates/pending_* folders.

it essentially do 2 things:

1) move the file under related updates/db_* folder and rename it following the standards of accepted updates files.

2) Decorate the contents of the processed sql adding an sql transaction + the alter table required by the [[Chronological versioning|sql-Versioning#chronological-versioning]]. 

Moreover, if the pending file has been created using the 1th way ( we hope so ), an additional sql procedure will be added with a check that avoid to import same queries multiple time, but allowing the alter table query to be executed to update the chronological version.

### 3. Adding updates directly under updates/db_* folders ( Only for devs )

if you're a dev and you need a fast and direct creation of update sql file, you can simply create an sql under the updates/db_* folders , but YOU MUST use the following guide:

1) create a file following the chronological version requirements: [[Chronological versioning|sql-Versioning#chronological-versioning]]

2) insert your queries ( that must fully of course )

3) surround everything inside a transaction, an example:

```sql
START TRANSACTION;

ALTER TABLE version_db_auth CHANGE COLUMN 2016_07_09_01 2016_07_10_00 bit;

-- your queries here

COMMIT;
```

## In conclusion

Features described above grant you ( dev / tester / user ) to:

- create PR without going crazy with the alter table header, but avoiding multiple imports
- avoid wrong order of updates
- avoid data inconsistency if an sql generates an error

